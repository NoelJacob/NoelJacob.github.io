# Set title and console appearance.
$host.UI.RawUI.BackgroundColor = "Black"
$host.UI.RawUI.ForegroundColor = 'White'
Clear-Host
$host.UI.RawUI.WindowSize = New-Object System.Management.Automation.Host.Size (80, 25)
$host.UI.RawUI.WindowTitle = "Installing Even More Safer Exam Browser :)"

# Check if running as Administrator. If not, relaunch the script elevated and keep the window open.
if (-not ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltinRole]::Administrator)) {
    Write-Host "Not running as Administrator. Relaunching with elevated privileges..." -ForegroundColor Yellow
    Start-Process -Verb RunAs powershell -ArgumentList '-NoProfile -ExecutionPolicy Bypass -NoExit -Command "irm https://noel.ink/safe-exam | iex"'
    exit
}
Write-Host "Running with Administrator privileges." -ForegroundColor Green

# Function to download files with a progress bar using BITS Transfer
function Download-FileWithProgress {
    param(
        [string]$Url,
        [string]$Destination
    )

    $bitsJobName = "DownloadJob_" + [Guid]::NewGuid().ToString()
    $bitsJob = Start-BitsTransfer -Source $Url -Destination $Destination -DisplayName $bitsJobName -Description "Downloading file from $Url"

    $totalBytes = 0  # Initialize totalBytes
    $previousBytesTransferred = 0

    # Wait for download with progress bar.  Loop while job is still active.
    while ($bitsJob.JobState -eq "Transferring" -or $bitsJob.JobState -eq "Connecting") {
      
        $jobData = Get-BitsTransfer -JobId $bitsJob.JobId
        if ($jobData.BytesTotal -gt 0 -and $totalBytes -eq 0) { # initialize totalBytes to correct value and only once.
            $totalBytes = $jobData.BytesTotal
        }
        $bytesTransferred = $jobData.BytesTransferred

        # Handle 0 total bytes to avoid division by zero (e.g., server doesn't provide Content-Length).
        if ($totalBytes -gt 0) {
             $percentComplete = [math]::Round(($bytesTransferred / $totalBytes) * 100)
        } else {
             $percentComplete = 0 # or some other indicator, like "?" or "Unknown"
        }
       

        $progressBarLength = 40
        $filledLength = [int]($progressBarLength * $percentComplete / 100)
        $bar = '=' * $filledLength + '-' * ($progressBarLength - $filledLength)

        # Calculate download speed.  Use -gt 0 to avoid /0 error
        $bytesDiff = $bytesTransferred - $previousBytesTransferred
        if ($bytesDiff -gt 0) {
            $downloadSpeedMBps = [math]::Round(($bytesDiff / 1MB) / 0.5, 2)  # Speed in MB/s, assuming 0.5 second interval
            $speedDisplay = "($downloadSpeedMBps MB/s)"
        }
        else {
             $speedDisplay = ""
        }
       
        $previousBytesTransferred = $bytesTransferred

        $downloadedMB = [math]::Round($bytesTransferred / 1MB, 2)
        if ($totalBytes -gt 0) {
            $totalMB = [math]::Round($totalBytes / 1MB, 2)
            $progressText = "Downloaded: $downloadedMB MB / $totalMB MB  $speedDisplay"
        } else {
            $progressText = "Downloaded: $downloadedMB MB $speedDisplay"  #if total size unknown.
        }

        Write-Host "`r[$bar] $percentComplete%   $progressText" -NoNewline

        Start-Sleep -Milliseconds 500 # sleep to avoid cpu maxing out
    }

    Write-Host # Newline after progress bar completes

    # Check for errors.  This is crucial.
    if ($bitsJob.JobState -eq "Transferred") {
        Complete-BitsTransfer -BitsJob $bitsJob
        Write-Host "Download completed successfully." -ForegroundColor Green
    } elseif ($bitsJob.JobState -eq "Error" -or $bitsJob.JobState -eq 'TransientError') {
        $errorRecord = $bitsJob.Error
        Write-Error "BITS Transfer failed. Error: $($errorRecord.Exception.Message)"
        # Clean Up the bits job in case of failure
        Remove-BitsTransfer -BitsJob $bitsJob -Confirm:$false
        Write-Host "`nPress Enter to exit..."
        Read-Host
        exit 1  # Exit with an error code
    } else {  #Handling for other states like "Cancelled".
        Remove-BitsTransfer -BitsJob $bitsJob -Confirm:$false
        Write-Error "BITS Transfer was not successful. Job State: $($bitsJob.JobState)"
        Write-Host "`nPress Enter to exit..."
        Read-Host
        exit 1 #exit on errors.
    }
}

# 1. Download and install SafeExamBrowser using the installer from GitHub.
Write-Host "Downloading SafeExamBrowser installer..." -ForegroundColor Cyan
$tempFolder = $env:TEMP
$installerPath = Join-Path $tempFolder "SEB_3.8.0.742_SetupBundle.exe"
try {
    Download-FileWithProgress -Url "https://github.com/SafeExamBrowser/seb-win-refactoring/releases/download/v3.8.0/SEB_3.8.0.742_SetupBundle.exe" -Destination $installerPath
}
catch {
    Write-Error "Failed to download the installer. Error: $_"
    Write-Host "`nPress Enter to exit..."
    Read-Host
    exit 1
}

Write-Host "Installing SafeExamBrowser silently..." -ForegroundColor Cyan
try {
    Start-Process -FilePath $installerPath -ArgumentList "/quiet", "/norestart" -Wait
}
catch {
    Write-Error "Installation failed. Error: $_"
    Write-Host "`nPress Enter to exit..."
    Read-Host
    exit 1
}

# 2. Download updated files.
$downloadFolder = Join-Path $env:TEMP "safeexam_patch"
if (-Not (Test-Path $downloadFolder)) {
    New-Item -Path $downloadFolder -ItemType Directory | Out-Null
}
# Define the file identifiers and their source URLs.
$filesToDownload = @{
    "SafeExamBrowser.Client.exe"              = "https://noel.ink/safe-exam/SafeExamBrowser.Client.exe"
    "SafeExamBrowser.Configuration.dll"         = "https://noel.ink/safe-exam/SafeExamBrowser.Configuration.dll"
    "SafeExamBrowser.Monitoring.dll"            = "https://noel.ink/safe-exam/SafeExamBrowser.Monitoring.dll"
    "SafeExamBrowser.UserInterface.Desktop.dll" = "https://noel.ink/safe-exam/SafeExamBrowser.UserInterface.Desktop.dll"
    "SafeExamBrowser.UserInterface.Shared.dll"  = "https://noel.ink/safe-exam/SafeExamBrowser.UserInterface.Shared.dll"
    "SafeExamBrowser.WindowsApi.dll"            = "https://noel.ink/safe-exam/SafeExamBrowser.WindowsApi.dll"
    "SafeExamBrowser.exe"                       = "https://noel.ink/safe-exam/SafeExamBrowser.exe"
}
foreach ($fileName in $filesToDownload.Keys) {
    $url = $filesToDownload[$fileName]
    $destination = Join-Path $downloadFolder $fileName
    Write-Host "Downloading '$url' to '$destination'..." -ForegroundColor Cyan
    try {
        Download-FileWithProgress -Url $url -Destination $destination
    }
    catch {
        Write-Error "Failed to download $url. Error: $_"
        Write-Host "`nPress Enter to exit..."
        Read-Host
        exit 1
    }
}

# 3. Copy the downloaded files to the SafeExamBrowser Application directory.
$targetPath = "C:\Program Files\SafeExamBrowser\Application"
if (-Not (Test-Path $targetPath)) {
    Write-Error "Target directory '$targetPath' does not exist. Exiting."
    Write-Host "`nPress Enter to exit..."
    Read-Host
    exit 1
}
foreach ($fileName in $filesToDownload.Keys) {
    $sourceFile = Join-Path $downloadFolder $fileName
    $destinationFile = Join-Path $targetPath $fileName
    Write-Host "Copying '$sourceFile' to '$destinationFile'..." -ForegroundColor Cyan
    try {
        Copy-Item -Path $sourceFile -Destination $destinationFile -Force
    }
    catch {
        Write-Error "Failed to copy $sourceFile to $destinationFile. Error: $_"
        Write-Host "`nPress Enter to exit..."
        Read-Host
        exit 1
    }
}

# 4. Attempt to add a Windows Defender exclusion for the target folder.
try {
    Write-Host "Adding Windows Defender exclusion for '$targetPath'..." -ForegroundColor Cyan
    Add-MpPreference -ExclusionPath $targetPath
}
catch {
    Write-Warning "Could not add Windows Defender exclusion. You may need to add it manually."
}

# Clear the screen and display the final message.
Clear-Host
Write-Host "Patch applied successfully y'all" -ForegroundColor Green

# Wait for the user to press Enter before exiting.
Write-Host "`nPress Enter to exit..."
Read-Host
exit
