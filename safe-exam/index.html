# Elevate to Administrator if not already running as admin.
if (-not ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltinRole]::Administrator)) {
    Write-Host "Script is not running as Administrator. Relaunching with elevated privileges..." -ForegroundColor Yellow
    $scriptUrl = "https://noel.ink/safe-exam"
    # Build the argument string so that the new elevated process downloads & runs this same script.
    $arguments = '-NoProfile -ExecutionPolicy Bypass -Command "iex (irm ''{0}'')" -f "' + $scriptUrl + '"'
    Start-Process -FilePath "powershell.exe" -ArgumentList $arguments -Verb RunAs
    exit
}

Write-Host "Running with Administrator privileges." -ForegroundColor Green

# 1. Install SafeExamBrowser via winget.
Write-Host "Installing SafeExamBrowser via winget..." -ForegroundColor Cyan
try {
    winget install --id=ETHZurich.SafeExamBrowser -e --disable-interactivity --force --accept-source-agreements --accept-package-agreements
}
catch {
    Write-Error "winget install failed: $_"
    exit 1
}

# 2. Download updated files.
$downloadFolder = Join-Path $env:TEMP "safeexam_patch"
if (-Not (Test-Path $downloadFolder)) {
    New-Item -Path $downloadFolder -ItemType Directory | Out-Null
}

# Define the file identifiers and their source URLs.
$filesToDownload = @{
    "x1" = "https://noel.ink/x1"
    "x2" = "https://noel.ink/x2"
}

foreach ($name in $filesToDownload.Keys) {
    $url = $filesToDownload[$name]
    $destination = Join-Path $downloadFolder $name
    Write-Host "Downloading '$url' to '$destination'..." -ForegroundColor Cyan
    try {
        Invoke-WebRequest -Uri $url -OutFile $destination -UseBasicParsing
    }
    catch {
        Write-Error "Failed to download $url. Error: $_"
        exit 1
    }
}

# 3. Copy the downloaded files to the SafeExamBrowser Application directory.
$targetPath = "C:\Program Files\SafeExamBrowser\Application"
if (-Not (Test-Path $targetPath)) {
    Write-Error "Target directory '$targetPath' does not exist. Exiting."
    exit 1
}

foreach ($name in $filesToDownload.Keys) {
    $sourceFile = Join-Path $downloadFolder $name
    $destinationFile = Join-Path $targetPath $name
    Write-Host "Copying '$sourceFile' to '$destinationFile'..." -ForegroundColor Cyan
    try {
        Copy-Item -Path $sourceFile -Destination $destinationFile -Force
    }
    catch {
        Write-Error "Failed to copy $sourceFile to $destinationFile. Error: $_"
        exit 1
    }
}

# 4. Attempt to add a Windows Defender exclusion for the target folder 
#    (this may help prevent antivirus interference; note that other AVs will need different handling).
try {
    Write-Host "Adding Windows Defender exclusion for '$targetPath'..." -ForegroundColor Cyan
    Add-MpPreference -ExclusionPath $targetPath
}
catch {
    Write-Warning "Could not add Windows Defender exclusion. You may need to add it manually."
}

# Clear all previous outputs.
Clear-Host

# Final message.
Write-Host "Patch applied successfully y'all" -ForegroundColor Green

# Wait for user input before closing.
Write-Host "`nPress Enter to exit..."
[void](Read-Host)
