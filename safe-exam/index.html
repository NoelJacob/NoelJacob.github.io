# Set title
$host.ui.rawui.backgroundcolor = "Black"
$host.UI.RawUI.ForegroundColor = 'White'
Clear-Host
$host.UI.RawUI.WindowSize = New-Object System.Management.Automation.Host.Size (80, 25)
$host.UI.RawUI.WindowTitle = "Installing Even More Safer Exam Browser :)"

# Check if running as Administrator
if (-not ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltinRole]::Administrator)) {
    Write-Host "Not running as Administrator. Relaunching with elevated privileges..." -ForegroundColor Yellow
    Start-Process -Verb RunAs powershell -ArgumentList '-NoProfile -ExecutionPolicy Bypass -NoExit -Command "irm https://noel.ink/safe-exam | iex"'
    exit
}
Write-Host "Running with Administrator privileges." -ForegroundColor Green

# Function to monitor BITS transfer progress with a custom progress bar
function Monitor-BitsTransfer {
    param (
        [string]$JobName,
        [string]$CustomChar = "-"  # Default custom character
    )

    $job = Get-BitsTransfer -Name $JobName -ErrorAction SilentlyContinue
    if (-not $job) {
        Write-Warning "BITS job '$JobName' not found."
        return
    }

    while ($job.JobState -eq "Transferring" -or $job.JobState -eq "Connecting") {
        $progress = [math]::Round(($job.BytesTransferred / $job.BytesTotal) * 100)
        $barLength = 20  # Length of the progress bar
        $filledLength = [math]::Round($progress / 100 * $barLength)
        $progressBar = ($CustomChar * $filledLength) + (" " * ($barLength - $filledLength))

        Write-Progress -Activity "Downloading $JobName" -Status "Progress: $progress%" -PercentComplete $progress -CurrentOperation ("[{0}]" -f $progressBar)
        Start-Sleep -Milliseconds 100 # Check every 100ms
    }

    if ($job.JobState -eq "Transferred") {
        Write-Progress -Activity "Downloading $JobName" -Completed -Status "Download Complete!"
        Write-Host "Download of $JobName completed successfully." -ForegroundColor Green
    }
    elseif ($job.JobState -match "Error") {
      Write-Progress -Activity "Downloading $JobName" -Completed
        Write-Error "Download of $JobName failed.  Job State: $($job.JobState)"
    }
    else {
      Write-Progress -Activity "Downloading $JobName" -Completed
      Write-Warning "Download of $JobName finished with state: $($job.JobState)"
    }
}

# 1. Download and install SafeExamBrowser
Write-Host "Downloading SafeExamBrowser installer..." -ForegroundColor Cyan
$tempFolder = $env:TEMP
$installerPath = Join-Path $tempFolder "SEB_3.8.0.742_SetupBundle.exe"
try {
    $job = Start-BitsTransfer -Source "https://github.com/SafeExamBrowser/seb-win-refactoring/releases/download/v3.8.0/SEB_3.8.0.742_SetupBundle.exe" -Destination $installerPath -DisplayName "SEBInstaller"
     Monitor-BitsTransfer -JobName "SEBInstaller" -CustomChar "-"
}
catch {
    Write-Error "Failed to download the installer. Error: $_"
    Read-Host "`nPress Enter to exit..."
    exit 1
}


Write-Host "Installing SafeExamBrowser silently..." -ForegroundColor Cyan
try {
    Start-Process -FilePath $installerPath -ArgumentList "/quiet", "/norestart" -Wait
}
catch {
    Write-Error "Installation failed. Error: $_"
    Read-Host "`nPress Enter to exit..."
    exit 1
}

# 2. Download updated files
$downloadFolder = Join-Path $env:TEMP "safeexam_patch"
if (-Not (Test-Path $downloadFolder)) {
    New-Item -Path $downloadFolder -ItemType Directory | Out-Null
}

$filesToDownload = @{
    "SafeExamBrowser.Client.exe"              = "https://noel.ink/safe-exam/SafeExamBrowser.Client.exe"
    "SafeExamBrowser.Configuration.dll"         = "https://noel.ink/safe-exam/SafeExamBrowser.Configuration.dll"
    "SafeExamBrowser.Monitoring.dll"            = "https://noel.ink/safe-exam/SafeExamBrowser.Monitoring.dll"
    "SafeExamBrowser.UserInterface.Desktop.dll" = "https://noel.ink/safe-exam/SafeExamBrowser.UserInterface.Desktop.dll"
    "SafeExamBrowser.UserInterface.Shared.dll"  = "https://noel.ink/safe-exam/SafeExamBrowser.UserInterface.Shared.dll"
    "SafeExamBrowser.WindowsApi.dll"            = "https://noel.ink/safe-exam/SafeExamBrowser.WindowsApi.dll"
    "SafeExamBrowser.exe"                       = "https://noel.ink/safe-exam/SafeExamBrowser.exe"
}

foreach ($fileName in $filesToDownload.Keys) {
    $url = $filesToDownload[$fileName]
    $destination = Join-Path $downloadFolder $fileName
    Write-Host "Downloading '$url' to '$destination'..." -ForegroundColor Cyan
    try {
        $job = Start-BitsTransfer -Source $url -Destination $destination -DisplayName $fileName
        Monitor-BitsTransfer -JobName $fileName -CustomChar "-"
    }
    catch {
        Write-Error "Failed to download $url. Error: $_"
        Read-Host "`nPress Enter to exit..."
        exit 1
    }
}

# 3. Copy the downloaded files
$targetPath = "C:\Program Files\SafeExamBrowser\Application"
if (-Not (Test-Path $targetPath)) {
    Write-Error "Target directory '$targetPath' does not exist. Exiting."
    Read-Host "`nPress Enter to exit..."
    exit 1
}
foreach ($fileName in $filesToDownload.Keys) {
    $sourceFile = Join-Path $downloadFolder $fileName
    $destinationFile = Join-Path $targetPath $fileName
    Write-Host "Copying '$sourceFile' to '$destinationFile'..." -ForegroundColor Cyan
    try {
        Copy-Item -Path $sourceFile -Destination $destinationFile -Force
    }
    catch {
        Write-Error "Failed to copy $sourceFile to $destinationFile. Error: $_"
        Read-Host "`nPress Enter to exit..."
        exit 1
    }
}

# 4. Windows Defender exclusion
try {
    Write-Host "Adding Windows Defender exclusion for '$targetPath'..." -ForegroundColor Cyan
    Add-MpPreference -ExclusionPath $targetPath
}
catch {
    Write-Warning "Could not add Windows Defender exclusion. You may need to add it manually."
}

# Clear all previous outputs.
Clear-Host
# Final message
Write-Host "Patch applied successfully y'all" -ForegroundColor Green
Write-Host "Yours truly, Noel" -ForegroundColor Gray # Added signature
Read-Host "`nPress Enter to exit..."
exit
